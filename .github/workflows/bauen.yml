name: Build Integration

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch version
        id: version
        run: |
          VERSION=$(cat driver.json | jq -r '.version')
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build with PyInstaller (aarch64)
        run: |
          docker run --rm --name builder \
            --platform=linux/arm64 \
            --user=$(id -u):$(id -g) \
            -v "$PWD":/workspace \
            docker.io/unfoldedcircle/r2-pyinstaller:3.11.13 \
            bash -c \
              "PYTHON_VERSION=\$(python --version | cut -d' ' -f2 | cut -d. -f1,2) && \
              python -m pip install --user -r requirements.txt && \
              PYTHONPATH=~/.local/lib/python\${PYTHON_VERSION}/site-packages:\$PYTHONPATH \
              pyinstaller --clean --onedir --name driver -y intg-onkyoavr/driver.py"

      - name: Create installation package
        run: |
          # Create package directory structure
          PKG_DIR=ucr2-intg-onkyoavr-${{ steps.version.outputs.VERSION }}
          mkdir -p ${PKG_DIR}/bin
          mkdir -p ${PKG_DIR}/config
          
          # Copy driver binary and dependencies
          cp -r dist/driver/* ${PKG_DIR}/bin/
          
          # Ensure executable
          chmod +x ${PKG_DIR}/bin/driver
          
          # Copy driver metadata
          cp driver.json ${PKG_DIR}/
          
          # Create tarball with correct structure
          tar czvf ${PKG_DIR}.tar.gz -C ${PKG_DIR} .
          
          # Verify structure
          echo "=== Package contents ==="
          tar -tzvf ${PKG_DIR}.tar.gz | head -30

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ucr2-intg-onkyoavr-${{ steps.version.outputs.VERSION }}
          path: ucr2-intg-onkyoavr-${{ steps.version.outputs.VERSION }}.tar.gz
          if-no-files-found: error
          retention-days: 30
